<?php
// Add AJAX handler for product loading
add_action('wp_ajax_load_products_by_category', 'load_products_by_category');
add_action('wp_ajax_nopriv_load_products_by_category', 'load_products_by_category');

function load_products_by_category()
{
    // Ensure required POST fields exist
    if (! isset($_POST['nonce']) || ! isset($_POST['category'])) {
        wp_send_json_error('Missing parameters');
    }

    // Verify nonce for security
    if (! wp_verify_nonce(sanitize_text_field(wp_unslash($_POST['nonce'])), 'products_nonce')) {
        wp_send_json_error('Security check failed');
    }

    $category = sanitize_text_field($_POST['category']);
    $home = get_template_directory_uri();

    // Base query args
    $args = array(
        'post_type' => 'product',
        'posts_per_page' => 8,
        'status' => 'publish'
    );

    // Modify query based on category
    switch ($category) {
        case 'featured':
            $args['tax_query'] = array(
                array(
                    'taxonomy' => 'product_visibility',
                    'field'    => 'name',
                    'terms'    => 'featured',
                ),
            );
            break;

        case 'on-sale':
            $on_sale_ids = wc_get_product_ids_on_sale();
            if (! empty($on_sale_ids)) {
                $args['post__in'] = $on_sale_ids;
            } else {
                // No on-sale products: make query return none
                $args['post__in'] = array(0);
            }
            break;

        case 'top-rated-product':
            // final taxonomy slug we want to query
            $top_rated_slug = 'top-rated-product';

            // If the product category term exists, query by product_cat taxonomy
            $term = get_term_by('slug', $top_rated_slug, 'product_cat');

            if ($term && ! is_wp_error($term)) {
                $args['tax_query'] = array(
                    array(
                        'taxonomy' => 'product_cat',
                        'field'    => 'slug',
                        'terms'    => array($top_rated_slug),
                        'operator' => 'IN',
                    ),
                );
            } else {
                // Fallback: query top-rated by rating meta (>= 4)
                $args['meta_query'] = array(
                    array(
                        'key'     => '_wc_average_rating',
                        'value'   => 4,
                        'compare' => '>=',
                        'type'    => 'NUMERIC',
                    ),
                );
                $args['orderby'] = 'meta_value_num';
                $args['order']   = 'DESC';
            }
            break;

        case 'all':
        default:
            // No additional args needed for all products
            break;
    }

    $products = new WP_Query($args);
    ob_start();

    if ($products->have_posts()) {
        while ($products->have_posts()) {
            $products->the_post();
            global $product;
            $product_id = $product->get_id();
            $product_type = $product->get_type();
            $is_variable = $product_type === 'variable';
?>
            <div class="col-lg-3 col-md-6 col-12">
                <div class="product-container">
                    <div class="product-img-holder">
                        <?php
                        if (has_post_thumbnail()) {
                            the_post_thumbnail('medium');
                        } else {
                            echo '<img src="' . $home . '/wp-content/themes/miheli-solutions/assets/images/test-img.png" alt="' . get_the_title() . '">';
                        }
                        ?>
                        <div class="product-hover-actions">
                            <button class="add-to-cart-btn" data-product-id="<?php echo $product_id; ?>" data-is-variable="<?php echo $is_variable ? 'true' : 'false'; ?>">
                                <i class="fa-solid fa-cart-plus"></i>
                            </button>

                            <a href="<?php the_permalink(); ?>" class="quick-view-btn">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                        </div>
                    </div>
                    <div class="product-content-holder">
                        <h6 class="product-title"><?php the_title(); ?></h6>
                        <p class="product-prize"><?php echo $product->get_price_html(); ?></p>
                        <p class="star-ratings">
                            <?php
                            // Display star ratings
                            $rating = $product->get_average_rating();
                            if ($rating > 0) {
                                echo wc_get_rating_html($rating);
                            } else {
                                // Fallback SVG if no ratings
                            ?>
                                <svg width="137" height="17" viewBox="0 0 137 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7.87292 2.00164C8.06503 1.42216 8.16104 1.13243 8.30311 1.05213C8.42601 0.982624 8.57397 0.982624 8.69696 1.05213C8.83895 1.13243 8.93496 1.42216 9.12707 2.00164L10.397 5.83256C10.4517 5.99749 10.479 6.07995 10.5283 6.14136C10.5718 6.19561 10.6273 6.23789 10.6899 6.26452C10.7608 6.29467 10.844 6.29644 11.0105 6.3L14.8774 6.38264C15.4624 6.39513 15.7548 6.40139 15.8716 6.51821C15.9726 6.61932 16.0183 6.76693 15.9933 6.91099C15.9644 7.07747 15.7313 7.26273 15.2651 7.63343L12.1829 10.0836C12.0502 10.1892 11.9839 10.2419 11.9434 10.31C11.9077 10.3702 11.8865 10.4386 11.8817 10.5092C11.8763 10.5893 11.9003 10.6728 11.9486 10.84L13.0686 14.722C13.238 15.3092 13.3227 15.6028 13.2528 15.7553C13.1923 15.8873 13.0726 15.9785 12.9342 15.9981C12.7743 16.0206 12.5342 15.8454 12.054 15.495L8.87919 13.1785C8.74252 13.0787 8.67422 13.0289 8.59995 13.0095C8.53431 12.9924 8.46568 12.9924 8.40012 13.0095C8.32585 13.0289 8.25747 13.0787 8.12079 13.1785L4.94607 15.495C4.46586 15.8454 4.22575 16.0206 4.06583 15.9981C3.92744 15.9785 3.80769 15.8873 3.7472 15.7553C3.67731 15.6028 3.76203 15.3092 3.93144 14.722L5.05145 10.84C5.09966 10.6728 5.12377 10.5893 5.11834 10.5092C5.11355 10.4386 5.09235 10.3702 5.05659 10.31C5.01612 10.2419 4.94978 10.1892 4.81709 10.0836L1.73499 7.63343C1.26878 7.26273 1.03567 7.07747 1.00674 6.91099C0.981685 6.76693 1.02743 6.61932 1.12844 6.51821C1.24515 6.40139 1.53762 6.39514 2.12254 6.38264L5.98949 6.3C6.15596 6.29644 6.2392 6.29467 6.31012 6.26452C6.37276 6.23789 6.42826 6.19561 6.47177 6.14136C6.52103 6.07995 6.54837 5.99749 6.60304 5.83256L7.87292 2.00164Z" fill="#FFAC42" stroke="#FFAC42" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M37.8729 2.00164C38.065 1.42216 38.161 1.13243 38.3031 1.05213C38.426 0.982624 38.574 0.982624 38.697 1.05213C38.8389 1.13243 38.935 1.42216 39.1271 2.00164L40.397 5.83256C40.4517 5.99749 40.479 6.07995 40.5283 6.14136C40.5718 6.19561 40.6273 6.23789 40.6899 6.26452C40.7608 6.29467 40.844 6.29644 41.0105 6.3L44.8774 6.38264C45.4624 6.39513 45.7548 6.40139 45.8716 6.51821C45.9726 6.61932 46.0183 6.76693 45.9933 6.91099C45.9644 7.07747 45.7313 7.26273 45.2651 7.63343L42.1829 10.0836C42.0502 10.1892 41.9839 10.2419 41.9434 10.31C41.9077 10.3702 41.8865 10.4386 41.8817 10.5092C41.8763 10.5893 41.9003 10.6728 41.9486 10.84L43.0686 14.722C43.238 15.3092 43.3227 15.6028 43.2528 15.7553C43.1923 15.8873 43.0726 15.9785 42.9342 15.9981C42.7743 16.0206 42.5342 15.8454 42.054 15.495L38.8792 13.1785C38.7425 13.0787 38.6742 13.0289 38.5999 13.0095C38.5343 12.9924 38.4657 12.9924 38.4001 13.0095C38.3258 13.0289 38.2575 13.0787 38.1208 13.1785L34.9461 15.495C34.4659 15.8454 34.2257 16.0206 34.0658 15.9981C33.9274 15.9785 33.8077 15.8873 33.7472 15.7553C33.6773 15.6028 33.762 15.3092 33.9314 14.722L35.0514 10.84C35.0997 10.6728 35.1238 10.5893 35.1183 10.5092C35.1135 10.4386 35.0924 10.3702 35.0566 10.31C35.0161 10.2419 34.9498 10.1892 34.8171 10.0836L31.735 7.63343C31.2688 7.26273 31.0357 7.07747 31.0067 6.91099C30.9817 6.76693 31.0274 6.61932 31.1284 6.51821C31.2452 6.40139 31.5376 6.39514 32.1225 6.38264L35.9895 6.3C36.156 6.29644 36.2392 6.29467 36.3101 6.26452C36.3728 6.23789 36.4283 6.19561 36.4718 6.14136C36.521 6.07995 36.5484 5.99749 36.603 5.83256L37.8729 2.00164Z" fill="#FFAC42" stroke="#FFAC42" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M67.8729 2.00164C68.065 1.42216 68.161 1.13243 68.3031 1.05213C68.426 0.982624 68.574 0.982624 68.697 1.05213C68.8389 1.13243 68.935 1.42216 69.1271 2.00164L70.397 5.83256C70.4517 5.99749 70.479 6.07995 70.5283 6.14136C70.5718 6.19561 70.6273 6.23789 70.6899 6.26452C70.7608 6.29467 70.844 6.29644 71.0105 6.3L74.8774 6.38264C75.4624 6.39513 75.7548 6.40139 75.8716 6.51821C75.9726 6.61932 76.0183 6.76693 75.9933 6.91099C75.9644 7.07747 75.7313 7.26273 75.2651 7.63343L72.1829 10.0836C72.0502 10.1892 71.9839 10.2419 71.9434 10.31C71.9077 10.3702 71.8865 10.4386 71.8817 10.5092C71.8763 10.5893 71.9003 10.6728 71.9486 10.84L73.0686 14.722C73.238 15.3092 73.3227 15.6028 73.2528 15.7553C73.1923 15.8873 73.0726 15.9785 72.9342 15.9981C72.7743 16.0206 72.5342 15.8454 72.054 15.495L68.8792 13.1785C68.7425 13.0787 68.6742 13.0289 68.5999 13.0095C68.5343 12.9924 68.4657 12.9924 68.4001 13.0095C68.3258 13.0289 68.2575 13.0787 68.1208 13.1785L64.9461 15.495C64.4659 15.8454 64.2257 16.0206 64.0658 15.9981C63.9274 15.9785 63.8077 15.8873 63.7472 15.7553C63.6773 15.6028 63.762 15.3092 63.9314 14.722L65.0514 10.84C65.0997 10.6728 65.1238 10.5893 65.1183 10.5092C65.1135 10.4386 65.0924 10.3702 65.0566 10.31C65.0161 10.2419 64.9498 10.1892 64.8171 10.0836L61.735 7.63343C61.2688 7.26273 61.0357 7.07747 61.0067 6.91099C60.9817 6.76693 61.0274 6.61932 61.1284 6.51821C61.2452 6.40139 61.5376 6.39514 62.1225 6.38264L65.9895 6.3C66.156 6.29644 66.2392 6.29467 66.3101 6.26452C66.3728 6.23789 66.4283 6.19561 66.4718 6.14136C66.521 6.07995 66.5484 5.99749 66.603 5.83256L67.8729 2.00164Z" fill="#FFAC42" stroke="#FFAC42" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M97.8729 2.00164C98.065 1.42216 98.161 1.13243 98.3031 1.05213C98.426 0.982624 98.574 0.982624 98.697 1.05213C98.8389 1.13243 98.935 1.42216 99.1271 2.00164L100.397 5.83256C100.452 5.99749 100.479 6.07995 100.528 6.14136C100.572 6.19561 100.627 6.23789 100.69 6.26452C100.761 6.29467 100.844 6.29644 101.01 6.3L104.877 6.38264C105.462 6.39513 105.755 6.40139 105.872 6.51821C105.973 6.61932 106.018 6.76693 105.993 6.91099C105.964 7.07747 105.731 7.26273 105.265 7.63343L102.183 10.0836C102.05 10.1892 101.984 10.2419 101.943 10.31C101.908 10.3702 101.886 10.4386 101.882 10.5092C101.876 10.5893 101.9 10.6728 101.949 10.84L103.069 14.722C103.238 15.3092 103.323 15.6028 103.253 15.7553C103.192 15.8873 103.073 15.9785 102.934 15.9981C102.774 16.0206 102.534 15.8454 102.054 15.495L98.8792 13.1785C98.7425 13.0787 98.6742 13.0289 98.5999 13.0095C98.5343 12.9924 98.4657 12.9924 98.4001 13.0095C98.3258 13.0289 98.2575 13.0787 98.1208 13.1785L94.9461 15.495C94.4659 15.8454 94.2257 16.0206 94.0658 15.9981C93.9274 15.9785 93.8077 15.8873 93.7472 15.7553C93.6773 15.6028 93.762 15.3092 93.9314 14.722L95.0514 10.84C95.0997 10.6728 95.1238 10.5893 95.1183 10.5092C95.1135 10.4386 95.0924 10.3702 95.0566 10.31C95.0161 10.2419 94.9498 10.1892 94.8171 10.0836L91.735 7.63343C91.2688 7.26273 91.0357 7.07747 91.0067 6.91099C90.9817 6.76693 91.0274 6.61932 91.1284 6.51821C91.2452 6.40139 91.5376 6.39514 92.1225 6.38264L95.9895 6.3C96.156 6.29644 96.2392 6.29467 96.3101 6.26452C96.3728 6.23789 96.4283 6.19561 96.4718 6.14136C96.521 6.07995 96.5484 5.99749 96.603 5.83256L97.8729 2.00164Z" stroke="#FFAC42" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M127.873 2.00164C128.065 1.42216 128.161 1.13243 128.303 1.05213C128.426 0.982624 128.574 0.982624 128.697 1.05213C128.839 1.13243 128.935 1.42216 129.127 2.00164L130.397 5.83256C130.452 5.99749 130.479 6.07995 130.528 6.14136C130.572 6.19561 130.627 6.23789 130.69 6.26452C130.761 6.29467 130.844 6.29644 131.01 6.3L134.877 6.38264C135.462 6.39513 135.755 6.40139 135.872 6.51821C135.973 6.61932 136.018 6.76693 135.993 6.91099C135.964 7.07747 135.731 7.26273 135.265 7.63343L132.183 10.0836C132.05 10.1892 131.984 10.2419 131.943 10.31C131.908 10.3702 131.886 10.4386 131.882 10.5092C131.876 10.5893 131.9 10.6728 131.949 10.84L133.069 14.722C133.238 15.3092 133.323 15.6028 133.253 15.7553C133.192 15.8873 133.073 15.9785 132.934 15.9981C132.774 16.0206 132.534 15.8454 132.054 15.495L128.879 13.1785C128.743 13.0787 128.674 13.0289 128.6 13.0095C128.534 12.9924 128.466 12.9924 128.4 13.0095C128.326 13.0289 128.257 13.0787 128.121 13.1785L124.946 15.495C124.466 15.8454 124.226 16.0206 124.066 15.9981C123.927 15.9785 123.808 15.8873 123.747 15.7553C123.677 15.6028 123.762 15.3092 123.931 14.722L125.051 10.84C125.1 10.6728 125.124 10.5893 125.118 10.5092C125.114 10.4386 125.092 10.3702 125.057 10.31C125.016 10.2419 124.95 10.1892 124.817 10.0836L121.735 7.63343C121.269 7.26273 121.036 7.07747 121.007 6.91099C120.982 6.76693 121.027 6.61932 121.128 6.51821C121.245 6.40139 121.538 6.39514 122.123 6.38264L125.989 6.3C126.156 6.29644 126.239 6.29467 126.31 6.26452C126.373 6.23789 126.428 6.19561 126.472 6.14136C126.521 6.07995 126.548 5.99749 126.603 5.83256L127.873 2.00164Z" stroke="#FFAC42" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />

                                </svg>
                            <?php
                            }
                            ?>
                        </p>
                    </div>
                </div>
            </div>
<?php
        }
        wp_reset_postdata();
    } else {
        echo '<div class="col-12 text-center w-100 h-100 d-flex align-items-center justify-content-center text-light">No products found in this category</div>';
    }

    $html = ob_get_clean();

    wp_send_json_success($html);
}
